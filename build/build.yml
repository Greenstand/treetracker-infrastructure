---

- name: Build docker containers
  hosts: localhost
  vars:
    mobile_api_dir: src/mobile-api
    mobile_api_dockerfile: TreetrackerMobileApi.Dockerfile
    admin_api_dir: src/admin-api
    admin_api_dockerfile: TreetrackerAdminApi.Dockerfile
    web_api_dir: src/web-api
    web_api_dockerfile: TreetrackerWebApi.Dockerfile
  tasks:
    - shell: 'date +"%s"'
      register: timestamp

    # treetracker-mobile-api
    - git:
        repo: git@github.com:Greenstand/treetracker-mobile-api.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ mobile_api_dir }}"

    - shell: "cd {{ mobile_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - set_fact:
        mobile_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - copy:
        src: "docker/{{ mobile_api_dockerfile }}"
        dest: "{{ mobile_api_dir }}/{{ mobile_api_dockerfile }}"

    - name: Build an image
      docker_image:
        path: "{{ mobile_api_dir }}"
        dockerfile: "{{ mobile_api_dockerfile }}"
        name: treetracker-mobile-api
        state: present

    - name: Tag this image
      docker_image:
        name: treetracker-mobile-api:latest
        tag: "{{ mobile_api_tag }}"
        state: present


    # treetracker-admin-api
    - git:
        repo: git@github.com:Greenstand/treetracker-admin.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ admin_api_dir }}"

    - shell: "cd {{ admin_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - set_fact:
        admin_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - copy:
        src: "docker/{{ admin_api_dockerfile }}"
        dest: "{{ admin_api_dir }}/server/{{ admin_api_dockerfile }}"

    - name: Build an image
      docker_image:
        path: "{{ admin_api_dir }}/server"
        dockerfile: "{{ admin_api_dockerfile }}"
        name: treetracker-admin-api
        state: present

    - name: Tag this image
      docker_image:
        name: treetracker-admin-api:latest
        tag: "{{ admin_api_tag }}"
        state: present


    # treetracker-web-api
    - git:
        repo: git@github.com:Greenstand/treetracker-web.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ web_api_dir }}"

    - shell: "cd {{ web_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - set_fact:
        web_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - copy:
        src: "docker/{{ web_api_dockerfile }}"
        dest: "{{ web_api_dir }}/server/{{ web_api_dockerfile }}"

    - name: Build an image
      docker_image:
        path: "{{ web_api_dir }}/server"
        dockerfile: "{{ web_api_dockerfile }}"
        name: treetracker-web-api
        state: present

    - name: Tag this image
      docker_image:
        name: treetracker-web-api:latest
        tag: "{{ web_api_tag }}"
        state: present
