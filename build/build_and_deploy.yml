---

- name: Build docker containers
  hosts: localhost
  vars:
    mobile_api_dir: src/mobile-api
    mobile_api_dockerfile: TreetrackerMobileApi.Dockerfile
    admin_api_dir: src/admin-api
    admin_api_dockerfile: TreetrackerAdminApi.Dockerfile
  tasks:
    - shell: 'date +"%s"'
      register: timestamp

    # treetracker-mobile-api
    - git:
        repo: git@github.com:Greenstand/treetracker-mobile-api.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ mobile_api_dir }}"

    - shell: "cd {{ mobile_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - copy:
        src: "docker/{{ mobile_api_dockerfile }}"
        dest: "{{ mobile_api_dir }}/Dockerfile"

    - name: Build mobile api image
      docker_image:
        path: "{{ mobile_api_dir }}"
        name: treetracker-mobile-api
        state: present
        force: yes


    # treetracker-admin-api
    - git:
        repo: git@github.com:Greenstand/treetracker-admin.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ admin_api_dir }}"

    - shell: "cd {{ admin_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - copy:
        src: "docker/{{ admin_api_dockerfile }}"
        dest: "{{ admin_api_dir }}/Dockerfile"

    - name: Build admin api image
      docker_image:
        path: "{{ admin_api_dir }}"
        name: treetracker-admin-api
        state: present
        force: yes


- name : Build and push greenstand image
  hosts: localhost

  tasks:
    - set_fact:
        mobile_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - set_fact:
        admin_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - name: Tag and push to Greenstand registry
      docker_image:
        name: "{{ item.image }}"
        repository: "{{item.tag}}"
        push: yes
      with_items:
      - image: treetracker-mobile-api:latest
        tag: ci.treetracker.org/treetracker-mobile-api:latest
      - image: treetracker-mobile-api:latest
        tag: "ci.treetracker.org/treetracker-mobile-api:{{mobile_api_tag}}"
      - image: treetracker-admin-api:latest
        tag: ci.treetracker.org/treetracker-admin-api:latest
      - image: treetracker-admin-api:latest
        tag: "ci.treetracker.org/treetracker-admin-api:{{admin_api_tag}}"


- name : Copy config to swarm
  hosts: swarm
  tasks:
    - name: make folder
      file:
        path: /opt/config
        state: directory
        mode: 0755
    - name: Copy config
      copy:
        src: config.js
        dest: /opt/config/config.js
        owner: root
        group: root
        mode: 0644
        backup: yes
        force: yes

- name : Update swarm
  hosts: swarm_manager
  tasks:
    - name: Install docker python
      apt:
        name: python3-docker
        state: present
    - name: Install pip
      apt:
        name: python3-pip
        state: present
    - name: Install docker python
      pip:
        name:
        - docker>=3.7.2
        - request>=2.20.1
    - name: Update swarm service
      tags: swarm_update
      docker_swarm_service:
        name: "{{ item.service }}"
        image: "{{item.image}}"
        force_update: yes
        mounts:
        - source: /opt/config
          target: /opt/config
        replicas: 2
      with_items:
        - image: ci.treetracker.org/treetracker-mobile-api:latest
          service: treetracker-mobile-api
        - image: ci.treetracker.org/treetracker-admin-api:latest
          service: treetracker-admin-api
