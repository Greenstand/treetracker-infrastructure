---

- name: Build docker containers
  hosts: localhost
  vars:
    mobile_api_dir: src/mobile-api
    mobile_api_dockerfile: TreetrackerMobileApi.Dockerfile
    admin_api_dir: src/mobile-api
    admin_api_dockerfile: TreetrackerAdminApi.Dockerfile
  tasks:
    - shell: 'date +"%s"'
      register: timestamp

    # treetracker-mobile-api
    - git:
        repo: git@github.com:Greenstand/treetracker-mobile-api.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ mobile_api_dir }}"

    - shell: "cd {{ mobile_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - set_fact:
        mobile_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - copy:
        src: "docker/{{ mobile_api_dockerfile }}"
        dest: "{{ mobile_api_dir }}/{{ mobile_api_dockerfile }}"

    - name: Build an image
      docker_image:
        path: "{{ mobile_api_dir }}"
        dockerfile: "{{ mobile_api_dockerfile }}"
        name: treetracker-mobile-api
        state: present

    - name: Tag this image
      docker_image:
        name: treetracker-mobile-api:latest
        tag: "{{ mobile_api_tag }}"
        state: present


    # treetracker-admin-api
    - git:
        repo: git@github.com:Greenstand/treetracker-admin.git
        depth: 1
        version: "{{ version }}"
        dest: "{{ admin_api_dir }}"

    - shell: "cd {{ admin_api_dir }}; git rev-parse --short HEAD"
      register: sha

    - set_fact:
        admin_api_tag: "{{ version }}-{{ timestamp.stdout }}-{{ sha.stdout }}"

    - copy:
        src: "docker/{{ admin_api_dockerfile }}"
        dest: "{{ admin_api_dir }}/{{ admin_api_dockerfile }}"

    - name: Build an image
      docker_image:
        path: "{{ admin_api_dir }}/server"
        dockerfile: "{{ admin_api_dockerfile }}"
        name: treetracker-admin-api
        state: present

    - name: Tag this image
      docker_image:
        name: treetracker-admin-api:latest
        tag: "{{ admin_api_tag }}"
        state: present

- name : Build and push greenstand image
  hosts: localhost
  vars:
    images_to_push:
    - image: treetracker-mobile-api:latest
    - image: treetracker-admin-api:latest
    - image: "treetracker-admin-api:{{admin_api_tag}}"
    - image: "treetracker-mobile-api:{{admin_mobile_tag}}"

  tasks:
    - debug:
        var: images_and_services
    - name: Tag and push to Greenstand registry
      docker_image:
        name: "{{ item.image }}"
        repository: "ci.treetracker.org/{{item.image}}"
        push: yes
        with_items: " {{ images_to_push }} "


- name : Copy config to swarm
  hosts: swarm
  tasks:
    - name: make folder
      file:
        path: /opt/config
        state: directory
        mode: 0755
    - name: Copy config
      copy:
        src: config.js
        dest: /opt/config/config.js
        owner: root
        group: root
        mode: 0644
        backup: yes
        force: yes

- name : Update swarm
  connection: network_cli
  hosts: swarm_manager
  vars:
    images_and_services:
    - image: treetracker-mobile-api:latest
      service: treetracker-mobile-api
    - image: treetracker-admin-api:latest
      service: treetracker-admin-api
  tasks:
    - name: Update swarm service
      docker_swarm_service:
        name: "{{ item.service }}"
        image: "ci.treetracker.org/{{item.image}}"
        mounts:
        - source: /opt/config
          target: /opt/config
        replicas: 2
      with_items: " {{ images_and_services }} "
