apiVersion: apps/v1
kind: Deployment
metadata:
  name: fabric-ca-root
  namespace: hyperledger-fabric
  labels:
    app: fabric-ca-root
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fabric-ca-root
  template:
    metadata:
      labels:
        app: fabric-ca-root
    spec:
      serviceAccountName: fabric-service-account
      containers:
      - name: fabric-ca-server
        image: hyperledger/fabric-ca:1.5.6
        ports:
        - containerPort: 7054
        env:
        - name: FABRIC_CA_HOME
          value: /etc/hyperledger/fabric-ca-server
        - name: FABRIC_CA_SERVER_CA_NAME
          value: ca-root
        - name: FABRIC_CA_SERVER_TLS_ENABLED
          value: "true"
        - name: FABRIC_CA_SERVER_PORT
          value: "7054"
        - name: FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS
          value: "0.0.0.0:17054"
        command: ["sh"]
        args:
        - -c
        - |
          fabric-ca-server init -b admin:adminpw
          fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server/ca-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server/msp/keystore/ca_key.pem -b admin:adminpw -d
        volumeMounts:
        - name: fabric-ca-data
          mountPath: /etc/hyperledger/fabric-ca-server
        - name: fabric-ca-config
          mountPath: /etc/hyperledger/fabric-ca-server/fabric-ca-server-config.yaml
          subPath: fabric-ca-server-config.yaml
      volumes:
      - name: fabric-ca-data
        persistentVolumeClaim:
          claimName: fabric-ca-pvc
      - name: fabric-ca-config
        configMap:
          name: fabric-ca-config
---
apiVersion: v1
kind: Service
metadata:
  name: fabric-ca-root-service
  namespace: hyperledger-fabric
spec:
  selector:
    app: fabric-ca-root
  ports:
  - name: ca-port
    port: 7054
    targetPort: 7054
  - name: operations
    port: 17054
    targetPort: 17054
  type: ClusterIP
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fabric-ca-pvc
  namespace: hyperledger-fabric
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fabric-storage
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fabric-ca-config
  namespace: hyperledger-fabric
data:
  fabric-ca-server-config.yaml: |
    version: 1.5.6
    port: 7054
    debug: false
    crlsizelimit: 512000
    tls:
      enabled: true
      certfile: /etc/hyperledger/fabric-ca-server/ca-cert.pem
      keyfile: /etc/hyperledger/fabric-ca-server/msp/keystore/ca_key.pem
    ca:
      name: ca-root
      keyfile: /etc/hyperledger/fabric-ca-server/msp/keystore/ca_key.pem
      certfile: /etc/hyperledger/fabric-ca-server/ca-cert.pem
      chainfile: /etc/hyperledger/fabric-ca-server/ca-chain.pem
    registry:
      maxenrollments: -1
      identities:
        - name: admin
          pass: adminpw
          type: client
          affiliation: ""
          attrs:
            hf.Registrar.Roles: "*"
            hf.Registrar.DelegateRoles: "*"
            hf.Revoker: true
            hf.IntermediateCA: true
            hf.GenCRL: true
            hf.Registrar.Attributes: "*"
            hf.AffiliationMgr: true
    db:
      type: sqlite3
      datasource: fabric-ca-server.db
      tls:
        enabled: false
    affiliations:
      greenstand:
        - admin
        - peer
      cbo:
        - admin
        - peer
      investor:
        - admin
        - peer
      verifier:
        - admin
        - peer
    signing:
      default:
        usage:
          - digital signature
        expiry: 8760h
      profiles:
        ca:
          usage:
            - cert sign
            - crl sign
          expiry: 43800h
          caconstraint:
            isca: true
            maxpathlenzero: true
        tls:
          usage:
            - signing
            - key encipherment
            - server auth
            - client auth
            - key agreement
          expiry: 8760h
    csr:
      cn: fabric-ca-server
      keyrequest:
        algo: ecdsa
        size: 256
      names:
        - C: US
          ST: "North Carolina"
          L:
          O: Hyperledger
          OU: Fabric
      hosts:
        - fabric-ca-root-service
        - localhost
    operations:
      listenAddress: 0.0.0.0:17054
      tls:
        enabled: false
