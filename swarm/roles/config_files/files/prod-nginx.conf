server {
    listen      80;
    listen [::]:80;

    location / {
        add_header X-server "$server_name";
        return 301 https://$host$request_uri;
    }

    location /health {
	access_log off;
        return 200;
    }

    location ^~ /.well-known/acme-challenge {
        root /var/lib/letsencrypt/webroot;
        default_type text/plain;
        allow all;
    }

}

server {
  listen 443 default_server ssl;

  ssl_certificate /run/secrets/fullchain.pem;
  ssl_certificate_key /run/secrets/privkey.pem;

  set $httpc  "http://";
  set $ip "172.17.0.1";
  set $lc "172.17.0.1";


    location ^~ /api/web {
        rewrite ^/api/web/(.*)$ /$1$is_args$args; break;
        proxy_pass "${httpc}${lc}:3000${uri}";
    }

    location ^~ /api/mobile {
        rewrite ^/api/mobile/(.*)$ /$1$is_args$args; break;
        proxy_pass "${httpc}${lc}:3001${uri}";
    }

    location ^~ /api/admin {
        rewrite ^/api/admin/(.*)$ /$1$is_args$args; break;
        proxy_pass "${httpc}${lc}:3002${uri}";
    }

    location ^~ /admin/ {
        rewrite ^/admin/(.*)$ /$1$is_args$args; break;
        proxy_pass "${httpc}${lc}:8081${uri}";
    }

    location ^~ /admin/api/admin {
        rewrite ^/admin/api/admin/(.*)$ /$1$is_args$args; break;
        proxy_pass "${httpc}${lc}:3002${uri}";
    }

    location ^~ / {
        rewrite ^/(.*)$ /$1$is_args$args; break;
        proxy_pass "${httpc}${lc}:8082${uri}";
    }

}
