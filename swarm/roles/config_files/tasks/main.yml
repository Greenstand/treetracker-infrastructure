# TODO: Create docker user to associate folders with
- name: make folder for config
  file:
    path: /opt/config
    state: directory
    mode: 0755
- name: Copy config
  template:
    src: "{{item}}"
    dest: "/opt/config/{{item}}"
    owner: root
    group: root
    mode: 0644
    backup: yes
    force: yes
  with_items:
  - config.js

- name: Copy datasources
  template:
    src: "{{item}}"
    dest: "/opt/config/{{item}}"
    owner: root
    group: root
    mode: 0644
    backup: yes
    force: yes
  with_items:
  - datasources.json

- name: Copy web map config
  template:
    src: "{{item}}"
    dest: "/opt/config/{{item}}"
    owner: root
    group: root
    mode: 0644
    backup: yes
    force: yes
  with_items:
  - web-map-config.js

- name: Copy reverse proxy config
  copy:
    src: "{{item}}"
    dest: "/opt/config/{{item}}"
    owner: root
    group: root
    mode: 0644
    backup: yes
    force: yes
  with_items:
  - prod-nginx.conf

- name: Add password protection to /admin endpoint
  htpasswd:
    path: /opt/config/nginx.htpasswd
    name: "{{admin_user}}"
    password: "{{admin_password}}"
    crypt_scheme: md5_crypt

- name: create folders for certs if non existant
  file:
    path: "{{item}}"
    state: directory
    mode: 0755
  with_items:
  - /opt/certbot/conf
  - /opt/certbot/lib
  - /opt/certbot/lib/webroot
